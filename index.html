<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Inventory Scanner</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
  font-family: Arial, sans-serif;
  text-align: center;
  background: #f5f5f5;
}

#reader {
  width: 300px;
  margin: 20px auto;
}

table {
  margin: 20px auto;
  border-collapse: collapse;
  background: white;
}

th, td {
  border: 1px solid #ccc;
  padding: 8px 12px;
}

button {
  padding: 8px 12px;
  margin: 10px;
}
</style>
</head>

<body>

<h2>Barcode Inventory Scanner</h2>

<div id="reader"></div>

<table id="dataTable">
<tr>
<th>#</th>
<th>Barcode</th>
<th>Quantity</th>
<th>First Scan</th>
</tr>
</table>

<button onclick="downloadCSV()">Download Excel</button>

<script>

let scannedItems = {};
let lastDetected = "";
let confirmCount = 0;
const requiredMatches = 2;
let lastScanTime = 0;
const cooldown = 1000;

// Simple checksum for UPC/EAN
function isValidBarcode(code) {
  if (!/^\d+$/.test(code)) return false;

  if (code.length !== 12 && code.length !== 13) {
    return true; // allow non-UPC codes
  }

  let sum = 0;
  let isEven = false;

  for (let i = code.length - 2; i >= 0; i--) {
    let digit = parseInt(code[i]);
    sum += isEven ? digit * 3 : digit;
    isEven = !isEven;
  }

  let checkDigit = (10 - (sum % 10)) % 10;
  return checkDigit === parseInt(code[code.length - 1]);
}

function onScanSuccess(decodedText) {

  if (!isValidBarcode(decodedText)) return;

  // Require 2 identical reads in a row
  if (decodedText === lastDetected) {
    confirmCount++;
  } else {
    lastDetected = decodedText;
    confirmCount = 1;
    return;
  }

  if (confirmCount < requiredMatches) return;

  const now = Date.now();
  if (now - lastScanTime < cooldown) return;
  lastScanTime = now;

  confirmCount = 0;

  if (scannedItems[decodedText]) {
    scannedItems[decodedText].qty++;
  } else {
    scannedItems[decodedText] = {
      qty: 1,
      time: new Date().toLocaleString()
    };
  }

  updateTable();
}

function updateTable() {
  const table = document.getElementById("dataTable");
  table.innerHTML = `
    <tr>
      <th>#</th>
      <th>Barcode</th>
      <th>Quantity</th>
      <th>First Scan</th>
    </tr>
  `;

  let index = 1;
  for (let code in scannedItems) {
    const row = table.insertRow();
    row.insertCell(0).innerText = index++;
    row.insertCell(1).innerText = code;
    row.insertCell(2).innerText = scannedItems[code].qty;
    row.insertCell(3).innerText = scannedItems[code].time;
  }
}

function downloadCSV() {
  let csv = "No,Barcode,Quantity,First Scan\n";
  let index = 1;

  for (let code in scannedItems) {
    csv += `${index++},${code},${scannedItems[code].qty},${scannedItems[code].time}\n`;
  }

  const blob = new Blob([csv], { type: "text/csv" });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "inventory.csv";
  a.click();
}

const scanner = new Html5QrcodeScanner("reader", {
  fps: 10,
  qrbox: 250
});

scanner.render(onScanSuccess);

</script>

</body>
</html>
