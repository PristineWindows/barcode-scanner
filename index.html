<script>
let scannedItems = {};
let scanDelay = 1200;
let lastScanTime = 0;

// Validation variables
let lastDetected = null;
let matchCount = 0;
const requiredMatches = 2; // Increase to 3 for stricter validation

// Beep sound
function beep() {
  const audio = new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");
  audio.play();
}

function onScanSuccess(decodedText) {
  // Only accept numeric barcodes
  if (!/^\d+$/.test(decodedText)) return;

  // Check repeated matches
  if (decodedText === lastDetected) {
    matchCount++;
  } else {
    lastDetected = decodedText;
    matchCount = 1;
    return;
  }

  // Only accept if scanned multiple times consecutively
  if (matchCount < requiredMatches) return;

  const now = Date.now();
  if (now - lastScanTime < scanDelay) return;
  lastScanTime = now;

  matchCount = 0; // reset

  beep();

  if (scannedItems[decodedText]) {
    scannedItems[decodedText].qty++;
  } else {
    scannedItems[decodedText] = {
      qty: 1,
      time: new Date().toLocaleString()
    };
  }

  updateTable();
}

function updateTable() {
  const table = document.getElementById("dataTable");
  table.innerHTML = `
    <tr>
      <th>#</th>
      <th>Barcode</th>
      <th>Quantity</th>
      <th>First Scan</th>
    </tr>
  `;

  let index = 1;
  for (let code in scannedItems) {
    const row = table.insertRow();
    row.insertCell(0).innerText = index++;
    row.insertCell(1).innerText = code;
    row.insertCell(2).innerText = scannedItems[code].qty;
    row.insertCell(3).innerText = scannedItems[code].time;
  }
}

const scanner = new Html5QrcodeScanner("reader", {
  fps: 10,
  qrbox: 250
});

scanner.render(onScanSuccess);

function downloadCSV() {
  let csv = "No,Barcode,Quantity,First Scan\n";
  let index = 1;
  for (let code in scannedItems) {
    csv += `${index++},${code},${scannedItems[code].qty},${scannedItems[code].time}\n`;
  }

  const blob = new Blob([csv], { type: "text/csv" });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "inventory.csv";
  a.click();
}
</script>
