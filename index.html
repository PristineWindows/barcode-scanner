<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Inventory Barcode Scanner</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f2f4f8;
  margin: 0;
  padding: 20px;
  text-align: center;
}

h2 {
  margin-bottom: 15px;
}

#reader {
  width: 320px;
  margin: auto;
  margin-bottom: 20px;
}

table {
  width: 100%;
  max-width: 600px;
  margin: auto;
  border-collapse: collapse;
  background: white;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 4px 10px rgba(0,0,0,0.05);
}

th {
  background: #007bff;
  color: white;
  padding: 12px;
}

td {
  padding: 10px;
  border-bottom: 1px solid #ddd;
}

tr:last-child td {
  border-bottom: none;
}

button {
  margin-top: 20px;
  padding: 12px 20px;
  border: none;
  border-radius: 8px;
  background: #28a745;
  color: white;
  font-size: 16px;
  cursor: pointer;
}

button:hover {
  opacity: 0.9;
}
</style>
</head>

<body>

<h2>ðŸ“¦ Inventory Barcode Scanner</h2>

<div id="reader"></div>

<h3>Scanned Items</h3>
<table id="dataTable">
<tr>
<th>#</th>
<th>Barcode</th>
<th>Quantity</th>
<th>First Scan</th>
</tr>
</table>

<button onclick="downloadCSV()">Download Excel File</button>

<script>
let scannedItems = {};
let scanDelay = 1200;       // Minimum delay between consecutive scans
let firstScanDelay = 2000;  // Delay before the first scan is accepted
let lastScanTime = 0;
let scannerStartedAt = Date.now();

// Validation variables
let lastDetected = null;
let matchCount = 0;
const requiredMatches = 2; // Increase to 3 for stricter validation

// Beep sound
function beep() {
  const audio = new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");
  audio.play();
}

function onScanSuccess(decodedText) {
  const now = Date.now();

  // Wait until initial focus delay passes
  if (now - scannerStartedAt < firstScanDelay) return;

  // Only accept numeric barcodes
  if (!/^\d+$/.test(decodedText)) return;

  // Check repeated matches
  if (decodedText === lastDetected) {
    matchCount++;
  } else {
    lastDetected = decodedText;
    matchCount = 1;
    return;
  }

  // Only accept if scanned multiple times consecutively
  if (matchCount < requiredMatches) return;

  if (now - lastScanTime < scanDelay) return;
  lastScanTime = now;

  matchCount = 0; // reset

  beep();

  if (scannedItems[decodedText]) {
    scannedItems[decodedText].qty++;
  } else {
    scannedItems[decodedText] = {
      qty: 1,
      time: new Date().toLocaleString()
    };
  }

  updateTable();
}

function updateTable() {
  const table = document.getElementById("dataTable");
  table.innerHTML = `
    <tr>
      <th>#</th>
      <th>Barcode</th>
      <th>Quantity</th>
      <th>First Scan</th>
    </tr>
  `;

  let index = 1;
  for (let code in scannedItems) {
    const row = table.insertRow();
    row.insertCell(0).innerText = index++;
    row.insertCell(1).innerText = code;
    row.insertCell(2).innerText = scannedItems[code].qty;
    row.insertCell(3).innerText = scannedItems[code].time;
  }
}

// Initialize scanner
const scanner = new Html5QrcodeScanner("reader", {
  fps: 10,
  qrbox: 250,
  experimentalFeatures: { useBarCodeDetectorIfSupported: true }
});

scanner.render(onScanSuccess);

function downloadCSV() {
  let csv = "No,Barcode,Quantity,First Scan\n";
  let index = 1;
  for (let code in scannedItems) {
    csv += `${index++},${code},${scannedItems[code].qty},${scannedItems[code].time}\n`;
  }

  const blob = new Blob([csv], { type: "text/csv" });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "inventory.csv";
  a.click();
}
</script>

</body>
</html>
