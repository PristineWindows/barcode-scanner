<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Inventory Barcode Scanner</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  background: #f2f4f8;
  text-align: center;
}

h2 {
  margin: 15px 0 5px 0;
}

#areaInput {
  width: 90%;
  max-width: 400px;
  padding: 10px;
  font-size: 16px;
  margin-bottom: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

#reader {
  width: 100%;
  height: 50vh;
}

table {
  width: 95%;
  margin: 15px auto;
  border-collapse: collapse;
  background: white;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 4px 10px rgba(0,0,0,0.05);
}

th {
  background: #007bff;
  color: white;
  padding: 10px;
}

td {
  padding: 8px;
  border-bottom: 1px solid #ddd;
}

button {
  padding: 6px 10px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
}

.deleteBtn {
  background: #dc3545;
  color: white;
}

.editBtn {
  background: #ffc107;
}

.exportBtn {
  margin: 15px;
  padding: 12px 20px;
  background: #28a745;
  color: white;
  font-size: 16px;
}
</style>
</head>

<body>

<h2>ðŸ“¦ Inventory Scanner</h2>

<input id="areaInput" placeholder="Enter Area / Location Name">

<div id="reader"></div>

<table id="dataTable">
<tr>
<th>#</th>
<th>Barcode</th>
<th>Qty</th>
<th>First Scan</th>
<th>Actions</th>
</tr>
</table>

<button class="exportBtn" onclick="downloadCSV()">Download Excel</button>

<script>

let scannedItems = {};
let lastScan = "";
let lastScanTime = 0;
let scanCooldown = 800; // fast but prevents spam

function beep() {
  const audio = new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");
  audio.play();
}

// Checksum validation
function isValidBarcode(code) {
  if (!/^\d+$/.test(code)) return false;
  if (code.length !== 12 && code.length !== 13) return true; 
  // If not UPC/EAN length, allow it (prevents blocking legit codes)

  let sum = 0;
  let isEven = false;

  for (let i = code.length - 2; i >= 0; i--) {
    let digit = parseInt(code[i]);
    sum += isEven ? digit * 3 : digit;
    isEven = !isEven;
  }

  let checkDigit = (10 - (sum % 10)) % 10;
  return checkDigit === parseInt(code[code.length - 1]);
}

function onScanSuccess(decodedText) {

  if (!isValidBarcode(decodedText)) return;

  const now = Date.now();

  if (decodedText === lastScan && now - lastScanTime < scanCooldown) {
    return;
  }

  lastScan = decodedText;
  lastScanTime = now;

  beep();

  if (scannedItems[decodedText]) {
    scannedItems[decodedText].qty++;
  } else {
    scannedItems[decodedText] = {
      qty: 1,
      time: new Date().toLocaleString()
    };
  }

  updateTable();
}

function updateTable() {
  const table = document.getElementById("dataTable");
  const areaName = document.getElementById("areaInput").value || "Unnamed Area";

  table.innerHTML = `
    <tr>
      <th colspan="5">${areaName}</th>
    </tr>
    <tr>
      <th>#</th>
      <th>Barcode</th>
      <th>Qty</th>
      <th>First Scan</th>
      <th>Actions</th>
    </tr>
  `;

  let index = 1;
  for (let code in scannedItems) {
    const row = table.insertRow();
    row.insertCell(0).innerText = index++;
    row.insertCell(1).innerText = code;
    row.insertCell(2).innerText = scannedItems[code].qty;
    row.insertCell(3).innerText = scannedItems[code].time;

    const actions = row.insertCell(4);
    actions.innerHTML = `
      <button class="editBtn" onclick="editQty('${code}')">Edit</button>
      <button class="deleteBtn" onclick="deleteItem('${code}')">Delete</button>
    `;
  }
}

function editQty(code) {
  let newQty = prompt("Enter new quantity:", scannedItems[code].qty);
  if (newQty !== null && !isNaN(newQty) && newQty > 0) {
    scannedItems[code].qty = parseInt(newQty);
    updateTable();
  }
}

function deleteItem(code) {
  if (confirm("Delete this item?")) {
    delete scannedItems[code];
    updateTable();
  }
}

function downloadCSV() {
  const areaName = document.getElementById("areaInput").value || "Unnamed Area";

  let csv = `Area: ${areaName}\n\n`;
  csv += "No,Barcode,Quantity,First Scan\n";

  let index = 1;
  for (let code in scannedItems) {
    csv += `${index++},${code},${scannedItems[code].qty},${scannedItems[code].time}\n`;
  }

  const blob = new Blob([csv], { type: "text/csv" });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `${areaName.replace(/\s+/g,'_')}_inventory.csv`;
  a.click();
}

// Fast scanner engine
const html5QrCode = new Html5Qrcode("reader");

Html5Qrcode.getCameras().then(devices => {
  if (devices && devices.length) {
    html5QrCode.start(
      { facingMode: "environment" },
      {
        fps: 15,
        qrbox: { width: 250, height: 250 }
      },
      onScanSuccess
    );
  }
}).catch(err => {
  alert("Camera error: " + err);
});

</script>

</body>
</html>
